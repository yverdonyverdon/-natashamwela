var Game={loaded:false,gameLoop:null,paused:false,container:null,settings:null,states:{},currentStateName:null,init:function(){window.addEventListener("keyup",function(e){Key.onKeyup(e)},false);window.addEventListener("keydown",function(e){Key.onKeydown(e)},false);this.container=document.getElementById("game")},load:function(){if(!this.loaded){this.loaded=true;this.resetContainers();this.gameLoop=window.setInterval(this.loop)}},stop:function(){clearInterval(this.gameLoop)},currentState:function(e){if(typeof e!=="undefined"){if(this.currentStateName){this.state().container.style.visibility="hidden"}this.currentStateName=e}else{e=this.currentStateName}if(typeof this.states[e]==="undefined"){this.states[e]=new State(e)}else{this.states[e].container.style.visibility="visible"}this.resetContainers();return this.states[e]},state:function(e){if(typeof e==="undefined"){e=this.currentStateName}if(typeof this.states[e]==="undefined"){console.log("Creating new state.");this.states[e]=new State(e);this.resetContainers()}return this.states[e]},resetContainers:function(){if(this.loaded){this.container=document.getElementById("game");for(var e in this.states){console.log("Updating state: "+e);this.states[e].container=document.getElementById("state-"+e);for(var t=0;t<this.states[e].items.length;t++){this.states[e].items[t].resetContainer()}}}},addItem:function(e,t){this.state().items[e]=t;this.resetContainers()},loop:function(){if(!Game.paused){for(i=0;i<Game.state().items.length;i++){Game.state().items[i].update()}}}};var Item=Class.create({state:null,id:0,name:null,x:0,y:0,container:null,initialize:function(e){this.state=Game.currentStateName;this.id=Game.state().items.length;this.name=e;Game.addItem(this.id,this);this.show()},resetContainer:function(){elements=document.getElementsByClassName("item-"+this.name);for(var e=0;e<elements.length;e++){if(elements[e].parentNode.id=="state-"+this.state){this.container=elements[e];return}else{console.log(elements[e].parentNode)}}},show:function(){if(!this.container){Game.state().container.innerHTML+='<div class="item-'+this.name+'"></div>'}else{this.container.style.visibility="visible"}},hide:function(){if(this.container){this.container.style.visibility="hidden"}},remove:function(){if(this.container){this.container.parentNode.removeChild(this.container);this.container=null}},hit:function(e){w=.5*(this.width+e.width);h=.5*(this.height+e.height);dx=this.x+this.width/2-(e.x+e.width/2);dy=this.y+this.height/2-(e.y+e.height/2);return Math.abs(dx)<w&&Math.abs(dy)<h},moveUp:function(e){e=typeof e!=="undefined"?e:1;this.y-=e;if(this.y<0){this.y=0}},moveDown:function(e){e=typeof e!=="undefined"?e:1;this.y+=e;if(this.y>250){this.y=250}},moveLeft:function(e){e=typeof e!=="undefined"?e:1;this.x-=e;if(this.x<0){this.x=0}},moveRight:function(e){e=typeof e!=="undefined"?e:1;this.x+=e;if(this.x>500){this.x=500}},update:function(){this.container.innerHTML=this.getOutput()},getOutput:function(){var e="";e+="<p>Id: "+this.id+"</p>";e+="<p>X:"+this.x+"</p>";e+="<p>Y:"+this.y+"</p>";return e}});var Key={_pressed:{},_released:{},SHIFT:16,CTRL:17,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,SEMICOLON:186,EQUALS:187,COMMA:188,DASH:189,PERIOD:190,SLASH:191,TILDE:192,LEFTHARDBRACKET:219,BACKSLASH:220,RIGHTHARDBRACKET:221,APOSTROPHE:222,isDown:function(e){delete this._released[e];return this._pressed[e]},wasReleased:function(e){return this._released[e]},onKeydown:function(e){delete this._released[e.keyCode];this._pressed[e.keyCode]=true},onKeyup:function(e){this._released[e.keyCode]=true;delete this._pressed[e.keyCode]}};var Player=Class.create(Item,{character:0,direction:0,_step:0,width:18,height:22,initialize:function(e){e("player")},step:function(){step=this._step;this._step++;if(this._step>40){this._step=0}return 4*Math.round(step/20)},moveUp:function(e,t){var n={x:this.x,y:this.y-t,width:this.width,height:this.height};for(var r=0;r<Game.state().solids.length;r++){if(Game.state().solids[r].hit(n)){return}}e(t);this.direction=2+this.step()},moveDown:function(e,t){var n={x:this.x,y:this.y+t,width:this.width,height:this.height};for(var r=0;r<Game.state().solids.length;r++){if(Game.state().solids[r].hit(n)){return}}e(t);this.direction=0+this.step()},moveLeft:function(e,t){var n={x:this.x-t,y:this.y,width:this.width,height:this.height};for(var r=0;r<Game.state().solids.length;r++){if(Game.state().solids[r].hit(n)){return}}e(t);this.direction=1+this.step()},moveRight:function(e,t){var n={x:this.x+t,y:this.y,width:this.width,height:this.height};for(var r=0;r<Game.state().solids.length;r++){if(Game.state().solids[r].hit(n)){return}}e(t);this.direction=3+this.step()},update:function(){speed=1;if(Key.isDown(Key.SHIFT)){speed*=2}if(Key.isDown(Key.UP)){this.moveUp(speed)}else if(Key.isDown(Key.DOWN)){this.moveDown(speed)}else if(Key.isDown(Key.LEFT)){this.moveLeft(speed)}else if(Key.isDown(Key.RIGHT)){this.moveRight(speed)}this.container.innerHTML=this.getOutput()},getOutput:function(){while(this.direction>11){this.direction-=12}var e=-(this.character%3)*360/3;var t=-Math.floor(this.character/3)*810/9;e-=this.direction%4*349/12;t-=Math.floor(this.direction/4)*798/27;var n="";n+='<img src="assets/transparent.gif" ';n+='style="width:'+this.width+"px; height:"+this.height+"px; background:url(assets/sprites/characters.png) "+e+" "+t+";";n+="position:fixed; left: "+this.x+"px; top:"+this.y+'px;">';return n}});var State=Class.create({container:null,name:null,tiles:{},items:[],solids:[],player:null,initialize:function(e){this.name=e;this.tiles={};this.items=[];Game.container.innerHTML+='<div id="state-'+e+'"></div>';this.resetContainer()},resetContainer:function(){this.container=document.getElementById("state-"+this.name)}});var Tile=Class.create(Item,{solid:false,width:17,height:16,left:0,top:0,displayed:false,resetContainer:function(e){if(!this.displayed){return e()}},update:function(){if(!this.displayed){this.displayed=true;this.container.innerHTML=this.getOutput()}},getOutput:function(){var e="";e+='<img src="assets/transparent.gif" ';e+='style="width:'+this.width+"px; height:"+this.height+"px; background:url(assets/sprites/tiles.png) "+this.left+" "+this.top+";";e+="position:fixed; left: "+this.x+"px; top:"+this.y+'px;">';return e}})